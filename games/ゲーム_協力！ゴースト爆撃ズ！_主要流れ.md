# 実装に関して

- 全ての API は叩ける状態に実装されている
  - API 関連の未実装 とは 叩く実装をしていないという意味
- API の URL は `https://db.rayfiyo.com/` を用いる
  - できれば `.env` などで可変的にしたい（障害対応のため）
- 今回実装するゲームは `協力！ゴースト爆撃ズ！` のみ

# 実装状況と流れ

1. Unity クライアントの起動（ゲームタイトルの画面）
   - 実装済み
2. ユーザー ID と コントローラ の接続開始
   - **一部** 実装済み
     - コントローラと Unity の繋ぎこみ**未実装** （最優先で実装）
     - 現時点ではユーザー ID の手動入力、QR コードなどを **検討中**
   - 待機列の取得に関して
     - API: `GET /api/games/lobby/{game_id}`
     - API レスポンス例:
       ```json
       {
         "gameId": "shooting",
         "lobby": {
           "1": {
             "id": "1tc5-4kh5",
             "name": "ほげほげ子",
             "personality": "2"
           },
           "2": {
             "id": "tujy-q055",
             "name": "ほげほげ夫",
             "personality": "1"
           },
           "3": {
             "id": "dryf-fbhu",
             "name": "ほげほげ郎",
             "personality": "3"
           },
           "4": null
         }
       }
       ```
3. 待機画面への遷移（Unity クライアント）
   - 実装済み
4. コントローラーの接続完了待ち
   - 実装済み（コントローラの繋ぎこみはまだ）
   - 4 人全員揃う or 待機画面を開いてで 99 秒経過を待つ と自動で接続完了となる
   - ユーザーから移動入力または攻撃入力がある間は 99 秒のカウントが早くなる
   - ユーザーの `personality` に応じて使えるキャラクターが異なる
     - 分析家(紫,A タイプ, personality: [0, 1, 2, 3])
     - 番人(青,B タイプ, personality: [12, 13, 14, 15])
     - 外交官(緑,C タイプ, personality: [8, 9, 10, 11])
     - 探検家(黄,D タイプ, personality: [4, 5, 6, 7])
     - 色は `public-spec/persona-go/design.md` の色と一部対応しておらず、
       Unity 側の変更を**要検討** （A タイプのみ紫(Unity)と赤(仕様書)で対応せず）
5. 接続完了、自動でゲーム開始（Unity クライアント）
6. ゲームの待機列を削除
   - **未実装**
   - API: `DELETE /api/games/lobby/{game_id}`
     - 現在、`{game_id}` は基本 `shooting` のみ入る
   - API のレスポンス例:
     ```json
     {
       "gameId": "shooting",
       "lobby": {
         "1": {
           "id": "1tc5-4kh5",
           "name": "ほげほげ子",
           "personality": "2"
         },
         "2": {
           "id": "tujy-q055",
           "name": "ほげほげ夫",
           "personality": "1"
         },
         "3": {
           "id": "dryf-fbhu",
           "name": "ほげほげ郎",
           "personality": "3"
         },
         "4": null
       }
     }
     ```
7. 次のプレイヤー組みの待機列を登録（更新）開始
   - **未実装**
   - API: `POST /api/games/lobby/{game_id}`
     - 現在、`{game_id}` は基本 `shooting` のみ入る
   - API リクエスト例:
     ```json
     {
       "gameId": "shooting",
       "lobby": {
         "1": "1tc5-4kh5",
         "2": "tujy-q055",
         "3": "dryf-fbhu",
         "4": null
       }
     }
     ```
   - API レスポンス例:
     ```json
     {
       "gameId": "shooting",
       "lobby": {
         "1": {
           "id": "1tc5-4kh5",
           "name": "ほげほげ子",
           "personality": "2"
         },
         "2": {
           "id": "tujy-q055",
           "name": "ほげほげ夫",
           "personality": "1"
         },
         "3": {
           "id": "dryf-fbhu",
           "name": "ほげほげ郎",
           "personality": "3"
         },
         "4": null
       }
     }
     ```
   - この API は全てのユーザーの上書き追加しかできないので、
     例えばユーザー１人を追加する場合は、
     `GET /api/games/lobby/{game_id}` の API を用いて事前にユーザーを取得しておく
8. ゲーム終了
9. ゲーム参加者の体験済みアトラクションを更新（追加）
   - **未実装**
   - 人数分行う
   - API: `POST /api/entry/attraction/{attraction_id}/visit`
     - このゲームの `{attraction_id}` は `games` である
   - API リクエスト例:
     ```json
     {
       "userId": "1tc5-4kh5",
       "staff": "スタッフ太郎"
     }
     ```
   - API レスポンス例:
     ```json
     {
       "attraction": "games",
       "staff": "スタッフ太郎",
       "user": {
         "id": "1tc5-4kh5",
         "name": "ほげほげ子",
         "personality": "2"
       }
     }
     ```
10. ゲーム結果の更新（登録）
    - **未実装**
    - API: `POST /api/games/result/{game_id}`
      - 現在、`{game_id}` は基本 `shooting` のみ入る
    - API リクエスト例:
      ```json
      {
        "startTime": "2025-08-27T14:32:15Z",
        "results": {
          "1": {
            "id": "1tc5-4kh5",
            "name": "ほげほげ子",
            "score": 85
          },
          "2": {
            "id": "tujy-q055",
            "name": "ほげほげ夫",
            "score": 72
          },
          "3": {
            "id": "dryf-fbhu",
            "name": "ほげほげ郎",
            "score": 64
          },
          "4": null
        }
      }
      ```
      - `startTime` はゲーム開始の時刻ではなく結果更新時の時刻でも良い
    - API レスポンス例:
      ```json
      {
        "gameId": "shooting",
        "playId": 12
      }
      ```
