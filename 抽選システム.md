# 抽選システムについて

## 抽選の概要

- 3 回のアトラクション体験で、抽選の権利を 1 回獲得
- 3 回以降のアトラクション体験で抽選の確率が上昇
- TODO: 抽選の回数に関するルールを決定する

## 抽選の権利獲得に関するルール

### 権利の獲得方法

- 3 回のアトラクション体験で、抽選の権利を 1 回獲得
- アトラクションの種類は問わない
- TODO: 性格診断はアトラクション体験数のカウント対象外？

### TODO: 権利獲得の上限

- 上限なし
- 1 人あたり N 回まで
- 1 日あたり N 回まで
- その他

### イレギュラーな事象に対する対応

- アプリを二人で共有していた
- アプリの不具合や入場スタッフのミスで権利が正しく付与されなかった
- 小さいこどもがどうしても抽選をしたいといっている

上記のような場合、抽選スタッフの判断で抽選を行うことができる。
ただし、抽選スタッフは事前にルールを確認し、適切に対応できるようにすること。

## 抽選方法に関するルール

### 景品と確率テーブル

| 区分     | 人数   | 参考確率  | 景品予算(単価) | 景品予算  |
| -------- | ------ | --------- | -------------- | --------- |
| 大当たり | 3 人   | 約 0.5%   | 500 円         | 1,500 円  |
| 中当たり | 30 人  | 約 5.5%   | 250 円         | 7,500 円  |
| 小当たり | 99 人  | 約 18%    | 150 円         | 14,850 円 |
| ハズレ   | 418 人 | 約 76%    | 60 円          | 25,080 円 |
| 合計     | 550 人 | 100%      | -              | 48,930 円 |

### 抽選確率の上昇ルール

- 現時点での在庫数に基づいて、抽選確率を動的に調整する
- ユーザーのアトラクション体験数に応じて、抽選確率を段階的に上昇させる
  - 3 回目のアトラクション体験で抽選権利獲得
  - 4 回目以降のアトラクション体験で、抽選確率が徐々に上昇
  - ただし、確率の上昇は一定の上限を設ける
- 抽選システム側では以下のパラメーターを調整可能
  - **各区分の重み**: どれを当たりやすくするかの調整が可能。ただし、透明性の観点から変更は慎重に行う
  - **確率上昇の大きさ**: アトラクション体験数に応じた確率上昇の度合いを調整可能
  - **確率上昇の上限**: 確率上昇の上限を設定し、過度な確率上昇を防止

### 抽選確率の算出方法

$$
賞区分: i \in \{\text{big}, \text{mid}, \text{small}, \text{lose}\} \\
在庫数: k_i \ge 0 \\
重み: w_i \ge 0 \\
最小体験回数(抽選権利獲得までの体験回数): N = 3 \\
体験回数: n \ge N \\

確率上昇の大きさ: \beta \ge 0 \\
確率上昇の上限: M_{cap} \ge 1 \\
$$

1. ベース確率(確率上昇前の確率)を計算
   $$ p^{(base)}_i = \frac{w_i k_i}{\sum_{j} w_j k_j} $$
2. 体験回数に基づく上昇倍率を計算
   $$ m(n) = \min(M_{cap}, 1 + \beta (n - N)) $$
   ※ただし、実装上は堅牢性の観点から
   $$ m(n) = \max(1, \min(M_{cap}, 1 + \beta (n - N))) $$
3. 最終的な抽選確率を計算
   $$ p_i' =
   \begin{cases}
   p_i^{(base)} \cdot m(n) & i \in \{\text{big},\text{mid},\text{small}\} \\
   p_i^{(base)} & i = \text{lose}
   \end{cases}
   $$

4. 正規化して最終確率を求める
    $$ q_i = \frac{p_i'}{\sum_j p_j'} $$
    ※ただし、実装上は正規化の前後で在庫がゼロの区分があれば、その区分の確率をゼロにする

## 運用方法・注意点

### 必要なもの

- 受付端末(カメラ(QRコード読み取り用)付きのPC)
- スピーカー
- ディスプレイ×2 (確率テーブル表示用、抽選結果表示用)
- 抽選スタッフ
- 景品
- 抽選権利付与用用のQRコード(イレギュラー対応用)

### 運用手順

1. 来場者はアプリのQRコードを受付端末で読み取る
2. 権利の有無を確認後、自動的に抽選が開始
3. 抽選結果に応じて、景品を決定・配布する
4. 終了後、スタッフが操作して受付状態に戻す

### イレギュラー対応

#### 抽選権利を持っていない場合

- スタッフの判断により、抽選を行うことができる
- 抽選を行う場合、ゲスト用のQRコードを端末で読み取る
- 確率の上昇は適用されない

#### システム上の在庫数と実際の在庫数が異なる場合

- スタッフが管理用画面から在庫数を手動で修正できる
- 在庫数は確率テーブルにも影響されるため、慎重な対応が必要

#### 確率の調整を行う場合

- スタッフは管理用画面からパラメーターを調整できる
- 透明性確保の観点から、頻繁な変更や大幅な変更は避け、パートリーダーの許可無く変更はしない

## UI・デザイン等に関して

### 確率テーブル表示用画面

- 来場者用(外付けディスプレイで表示)
- 区分, 景品内容, 確率 が書かれた表
- 在庫数とパラメータによってリアルタイムに確率は変動
- 在庫切れの項目については「終了」のような表示
- 確率がリアルタイムに変動するため、透明性確保の観点から「在庫数よって当選確率は変わります」のような注意書きも必要

### 抽選結果表示用画面

- 来場者用(外付けディスプレイで表示)
- 抽選中の演出と結果表示を行う
- TODO: 演出の案
  - ルーレット的
  - ガチャ的
  - その他
- 効果音なども検討

### 管理用画面

- スタッフ用(PCのディスプレイで表示)
- 直近n回の抽選結果
- システム上での在庫の確認と調整
- 抽選のパラメータ確認と調整
